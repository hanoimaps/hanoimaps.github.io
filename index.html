<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hanoi Maps</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link
      href="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.js"></script>
    <style>
      html,
      body,
      #map {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      .layer-switcher {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 6px;
        border-radius: 8px;
        border: 1px solid #ccc;
        z-index: 1000;
      }
      .layer-switcher select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border: none;
        background: none;
        font-size: 16px;
        outline: none;
        cursor: pointer;
        color: #000;
      }
      #opacity-slider {
        position: absolute;
        z-index: 1001;
        right: -40px;
        top: 50%;
        width: 140px;
        height: 48px;
        background: transparent;
        transform: translateY(-50%) rotate(-90deg);
        transform-origin: center;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="layer-switcher">
      <select id="historic-layer-select"></select>
    </div>
    <div id="opacity-slider-wrapper">
      <input
        type="range"
        id="opacity-slider"
        min="0"
        max="1"
        step="0.01"
        value="0.7"
        aria-label="opacity"
      />
    </div>

    <script>
      const mapData = [
        {
          year: "1891b",
          title: "1891",
          extent: [
            11778560.336252, 2392587.212477, 11784755.133579, 2397546.240792,
          ],
        },
        {
          year: "1894",
          title: "1894",
          extent: [
            11779981.310497, 2391348.205003, 11785722.827001, 2398582.38102,
          ],
        },
        {
          year: "1926",
          title: "1926",
          extent: [
            11781193.523914, 2394570.994076, 11784797.946318, 2397374.208348,
          ],
        },
        {
          year: "1929",
          title: "1929",
          extent: [
            11776835.274703, 2391277.184008, 11786703.296099, 2398630.593322,
          ],
        },
        {
          year: "1930",
          title: "1930",
          extent: [
            11780273.832504, 2391782.534119, 11785154.944323, 2398620.242014,
          ],
        },
        {
          year: "1932",
          title: "1932",
          extent: [
            11779787.67009, 2391236.908184, 11786395.079343, 2398500.538078,
          ],
        },
        {
          year: "1942a",
          title: "1942",
          extent: [
            11778407.93035, 2391208.420221, 11786963.948359, 2398505.336837,
          ],
        },
        {
          year: "1952",
          title: "1952",
          extent: [
            11780196.139688, 2392283.311738, 11785605.082601, 2399324.539199,
          ],
        },
      ];
      const apiKey = "JOtQQjkj3YJ9dZzJKMJs";
      const minZoomLevel = 12;
      const maxZoomLevel = 18;

      const layerSelect = document.getElementById("historic-layer-select");
      const opacitySlider = document.getElementById("opacity-slider");
      let symbolLayerIds = [];

      function transformExtent(extent) {
        const R = 20037508.34;
        const lon1 = (extent[0] / R) * 180;
        const lat1 =
          (180 / Math.PI) *
          (2 * Math.atan(Math.exp((extent[1] / R) * Math.PI)) - Math.PI / 2);
        const lon2 = (extent[2] / R) * 180;
        const lat2 =
          (180 / Math.PI) *
          (2 * Math.atan(Math.exp((extent[3] / R) * Math.PI)) - Math.PI / 2);
        return [lon1, lat1, lon2, lat2];
      }

      // --- Initialize Map ---
      const map = new maplibregl.Map({
        container: "map",
        style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${apiKey}`,
        center: [105.8542, 21.0285],
        zoom: minZoomLevel,
      });

      mapData.forEach((data) => {
        const option = document.createElement("option");
        option.value = data.year;
        option.textContent = data.title;
        layerSelect.appendChild(option);
      });

      map.on("load", () => {
        const firstSymbolId = map
          .getStyle()
          .layers.find((l) => l.type === "symbol")?.id;

        symbolLayerIds = map
          .getStyle()
          .layers.filter((layer) => layer.type === "symbol")
          .map((layer) => layer.id);

        mapData.forEach((data, index) => {
          const layerId = `historic-${data.year}`;
          map.addSource(layerId, {
            type: "raster",
            tiles: [`/maps-tiles/${data.year}/{z}/{x}/{y}.png`],
            scheme: "tms",
            tileSize: 256,
            minzoom: minZoomLevel,
            maxzoom: maxZoomLevel,
            bounds: transformExtent(data.extent),
          });

          map.addLayer(
            {
              id: layerId,
              type: "raster",
              source: layerId,
              paint: {
                "raster-opacity": parseFloat(opacitySlider.value),
              },
              layout: {
                visibility: index === 0 ? "visible" : "none",
              },
            },
            firstSymbolId
          );
        });

        if (mapData.length > 0) {
          map.fitBounds(transformExtent(mapData[0].extent), {
            padding: 50,
            duration: 0,
          });
        }

        // Now it's safe to add controls
        map.addControl(
          new maplibregl.NavigationControl({ showCompass: false }),
          "top-left"
        );
        map.addControl(
          new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true,
          }),
          "top-left"
        );

        console.log("Setup complete. Controls and layers are ready.");
      });

      // --- EVENT LISTENERS for user interaction ---

      // Handles changing the year from the dropdown
      function changeHistoricLayer() {
        const selectedYear = layerSelect.value;

        mapData.forEach((data) => {
          const layerId = `historic-${data.year}`;
          const visibility = data.year === selectedYear ? "visible" : "none";
          if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, "visibility", visibility);
          }
        });

        const selectedMap = mapData.find((data) => data.year === selectedYear);
        if (selectedMap) {
          map.fitBounds(transformExtent(selectedMap.extent), {
            padding: 50,
          });
        }
      }

      // Handles changing the opacity from the slider
      function changeOpacity() {
        const opacity = parseFloat(opacitySlider.value);
        mapData.forEach((data) => {
          const layerId = `historic-${data.year}`;
          if (map.getLayer(layerId)) {
            map.setPaintProperty(layerId, "raster-opacity", opacity);
          }
        });

        const newVisibility = opacity >= 0.6 ? "none" : "visible";
        symbolLayerIds.forEach((id) => {
          map.setLayoutProperty(id, "visibility", newVisibility);
        });
      }

      layerSelect.addEventListener("change", changeHistoricLayer);
      opacitySlider.addEventListener("input", changeOpacity);
    </script>
    <script>
      // Service worker logic (unchanged)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("Service Worker registered for caching.");
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
